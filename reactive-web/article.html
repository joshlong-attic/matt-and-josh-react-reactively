<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Going Reactive with WebFlux</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Going Reactive with WebFlux</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_io_io_its_off_to_work_we_go">I/O, I/O, It&#8217;s Off to Work We Go&#8230;&#8203;</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Reactive programming is an approach to writing software that embraces asynchronous IO. Asynchronous I/O is a small idea that portends big changes for software. The idea is simple: alleviate inefficient resource utilization by reclaiming resources that would otherwise be idle as they waited for I/O activity. Asynchronous IO inverts the normal design of IO processing: the clients are notified of new data instead of asking for it; this frees the client to do other things while waiting for new notifications. Let&#8217;s look at an example that compares and contrasts asynchronous IO to synchronous IO.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s build a simple program that reads data from a source (a <code>java.io.File</code> reference, specifically). First up, an implementation that uses a trusty 'ol <code>java.io.InputStream</code> implementation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Read data from a file <em>synchronously</em></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.io;

import lombok.extern.log4j.Log4j2;
import org.springframework.util.FileCopyUtils;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.function.Consumer;

@Log4j2
class Synchronous implements Reader {

		@Override
		public void read(File file, Consumer&lt;BytesPayload&gt; consumer) throws IOException {
				try (FileInputStream in = new FileInputStream(file)) { <b class="conum">(1)</b>
						byte[] data = new byte[FileCopyUtils.BUFFER_SIZE];
						int res;
						while ((res = in.read(data, 0, data.length)) != -1) { <b class="conum">(2)</b>
								consumer.accept(BytesPayload.from(data, res)); <b class="conum">(3)</b>
						}
				}
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>source the file using a regular <code>java.io.File</code></p>
</li>
<li>
<p><em>pull</em> the results out of the source one line at a time..</p>
</li>
<li>
<p>I&#8217;ve written this code to accept a <code>Consumer&lt;BytesPayload&gt;</code> that gets called when there&#8217;s new data</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Pretty straightforward, eh? Run this and you&#8217;ll see in the log output, on the left hand side of each line, that all activity is happening on a single thread.</p>
</div>
<div class="paragraph">
<p>We&#8217;re <em>pulling</em> bytes out of a source of data (in this case, a <code>java.io.InputStream</code> subclass, <code>java.io.FileInputStream</code>). What&#8217;s wrong with this example? Well, probably nothing! In this case we&#8217;re using an <code>InputStream</code> that&#8217;s pointing to data on the local file system. If the file is there, and the hard drive is working, then this code will work as we expect.</p>
</div>
<div class="paragraph">
<p>What if, instead of reading data from a <code>File</code>, we read data from a network socket, and used a different implementation of an <code>InputStream</code>? Nothing to worry about! Well, nothing to worry about if the network is infinitely fast, at least. And if the network link between this node and another never fails. If those things are true, then there&#8217;s certainly nothing to worry about! This code will work just fine..</p>
</div>
<div class="paragraph">
<p>What happens if the network is slow, or down? In this case, it&#8217;d mean that the time it takes for the <code>in.read(&#8230;&#8203;)</code> operation to return would be prolonged. Indeed, it may never return! This is a problem if we&#8217;re trying to do something else with the thread on which we&#8217;re reading data. Sure, we can spin up another thread and read from that one instead. We could keep this up to a point, but eventually we&#8217;ll run into a limit where adding threads doesn&#8217;t support our goal of scaling. We won&#8217;t have true concurrency beyond the number of cores on our machine. We&#8217;re stuck! We can&#8217;t handle more I/O, reads in this case, without adding threads, and our ability to scale up with more threads is, ultimately, limited.</p>
</div>
<div class="paragraph">
<p>In that example, the bulk of the work is in the reading - there&#8217;s not much else going on anywhere. We are <em>_I/O bound</em>. Let&#8217;s see how an asynchronous solution can help us alleviate the monopolization of our threads.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Read data from a file <em>asynchronously</em></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.io;

import lombok.extern.log4j.Log4j2;
import org.springframework.util.FileCopyUtils;

import java.io.File;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.channels.AsynchronousFileChannel;
import java.nio.channels.CompletionHandler;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.util.Collections;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.function.Consumer;

@Log4j2
class Asynchronous implements Reader, CompletionHandler&lt;Integer, ByteBuffer&gt; {

		private int bytesRead;
		private long position;
		private AsynchronousFileChannel fileChannel;
		private Consumer&lt;BytesPayload&gt; consumer;
		private final ExecutorService executorService = Executors.newFixedThreadPool(10);

		public void read(File file, Consumer&lt;BytesPayload&gt; c) throws IOException {
				this.consumer = c;
				Path path = file.toPath(); <b class="conum">(1)</b>
				this.fileChannel = AsynchronousFileChannel.open(path,
					Collections.singleton(StandardOpenOption.READ), this.executorService); <b class="conum">(2)</b>
				ByteBuffer buffer = ByteBuffer.allocate(FileCopyUtils.BUFFER_SIZE);
				this.fileChannel.read(buffer, position, buffer, this); <b class="conum">(3)</b>
				while (this.bytesRead &gt; 0) {
						this.position = this.position + this.bytesRead;
						this.fileChannel.read(buffer, this.position, buffer, this);
				}
		}

		@Override
		public void completed(Integer result, ByteBuffer buffer) {
				<b class="conum">(4)</b>
				this.bytesRead = result;

				if (this.bytesRead &lt; 0)
						return;

				buffer.flip();

				byte[] data = new byte[buffer.limit()];
				buffer.get(data);

				<b class="conum">(5)</b>
				consumer.accept(BytesPayload.from(data, data.length));

				buffer.clear();

				this.position = this.position + this.bytesRead;
				this.fileChannel.read(buffer, this.position, buffer, this);
		}

		@Override
		public void failed(Throwable exc, ByteBuffer attachment) {
				log.error(exc);
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this time, we adapt the <code>java.io.File</code> into a Java NIO <code>java.nio.file.Path</code></p>
</li>
<li>
<p>when we create the <code>Channel</code>, we specify, among other things, a <code>java.util.concurrent.ExecutorService</code>, that will be used to invoke our <code>CompletionHandler</code> when there&#8217;s data available.</p>
</li>
<li>
<p>start reading, passing in a reference to a <code>CompletionHandler&lt;Integer, ByteBuffer&gt;</code> (<code>this</code>).</p>
</li>
<li>
<p>in the callback, we read the bytes out of  a <code>ByteBuffer</code> into a <code>byte[]</code> holder.</p>
</li>
<li>
<p>Just as in the <code>Synchronous</code> example, the <code>byte[]</code> data is passed to a consumer.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>First thing&#8217;s first: this code&#8217;s <em>waaaay</em> more complicated! There&#8217;s a ton of things going on here and it can seem overwhelming, but indulge me, for a moment&#8230;&#8203; This code  reads data from a Java NIO <code>Channel</code> and processes that data, asynchronously, on a separate thread in a callback handler. The thread on which the read was started isn&#8217;t monopolized. We return virtually instantly after we call <code>.read(..)</code>, and when there is finally data available, our callback is invoked, and on a different thread. If there is latency between <code>.read()</code> calls, then we can move on and do other things with our thread. The duration of the asynchronous read, from the first byte to the last, is at best as short as the duration of the synchronous read. It&#8217;s likely a tiny bit longer. But, for that complexity, we can be more efficient with our threads. We can handle more work, multiplexing I/O across a finite thread pool.</p>
</div>
<div class="paragraph">
<p>I work for a cloud computing company. We&#8217;d  <em>love</em> it if you solved your scale-out problems by buying more application instances! Of course I&#8217;m being a bit tongue-in-cheek  here. Asynchronous IO <em>_does</em> make things a bit more complicated, but hopefully this example highlights the ultimate benefit of reactive code: we can handle more requests, and do more work, using asynchronous I/O on the same hardware <em>if</em> our work is IO bound. If it&#8217;s CPU-bound  (e.g.: fibonacci, bitcoin mining, or cryptography) then reactive programming won&#8217;t buy us anything.</p>
</div>
<div class="paragraph">
<p>Now, most of us don&#8217;t work with <code>Channel</code> <em>or</em> <code>InputStream</code> implementations for their day-to-day work! They think about things in terms of higher order abstractions. Things like the arrays, or, more likely, the <code>java.util.Collection</code> hierarchy. A <code>java.util.Collection</code> maps very nicely to an <code>InputStream</code>: they both   assume that you&#8217;ll be able to work with all the data, near instantly. You expect to be able to finish reading from most <code>InputStreams</code> sooner rather than later.  Collection types start to become a bit awkward when you move to larger sums of data; what happens when you&#8217;re dealing with something potentially infinite - unbounded - like websockets, or server-sent events? What happens when there&#8217;s latency between records? One record arrives now and another not for another minute or hour  such as with a chat, or when the network suffers a failure?</p>
</div>
<div class="paragraph">
<p>We need a better way to describe these kinds of data. We&#8217;re describing something asynchronous - something that will <em>eventually</em> happen. This might seem a good fit for a <code>Future&lt;T&gt;</code> or a <code>CompletableFuture&lt;T&gt;</code>, but that only describes <em>one</em> eventual thing. Not a whole stream of potentially unlimited things. Java hasn&#8217;t really offered an appropriate metaphor by which to describe this kind of data.  Both <code>Iterator</code> and Java 8 <code>Stream</code> types can be unbounded, but they are both pull-centric; you ask for the next record instead of having the type call your code back. One assumes that if they did support push-based processing, which lets you do more with your threads, that the APIs would also expose threading and scheduling control. <code>Iterator</code> implementations say nothing about threading and Java 8 streams <em>all</em> share the same fork-join pool.</p>
</div>
<div class="paragraph">
<p>If <code>Iterator</code> and <code>Stream</code> did support push-based processing, then we&#8217;d run into another problem that really only becomes an issue in the context of IO: we&#8217;d need some way to  <em>push back</em>!  As a consumer of data being produced asynchronously, we have no idea when or how much data might be in the pipeline. We don&#8217;t know if one byte will be produced in the next callback or a if terabyte will be produced! When you pull data off of an <code>InputStream</code>, you read as much data as you&#8217;re prepared to handle, and no more. In the examples above we read into a <code>byte[]</code>  buffer of a fixed and known length. In an asynchronous world, we need someway to communicate to the producer how much data we&#8217;re prepared to handle.</p>
</div>
<div class="paragraph">
<p>Yep. We&#8217;re <em>definitely</em> missing something.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_missing_metaphor">The Missing Metaphor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What we want is something that maps nicely to asynchronous I/O, and that supports this push-back mechanism, or  <em>flow control</em>, in distributed systems. In reactive programming, the ability of the client to signal how much work it can manage tis called <em>backpressure</em>. There are a good deal many projects -  Vert.x, Akka Streams, and RxJava - that support reactive programming. The Spring team has a project called <a href="http://projectreactor.io">Reactor</a>. There&#8217;s common enough ground across these different approaches extracted into a de-facto standard, <a href="http://www.reactive-streams.org">the Reactive Streams initiative</a>. The Reactive Streams initiative defines four types:</p>
</div>
<div class="paragraph">
<p>The <code>Publisher&lt;T&gt;</code> is a producer of values that may eventually arrive. A <code>Publisher&lt;T&gt;</code> produces values of type <code>T</code> to a <code>Subscriber&lt;T&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. the Reactive Streams <code>Publisher&lt;T&gt;</code>.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.reactivestreams;

public interface Publisher&lt;T&gt; {

    void subscribe(Subscriber&lt;? super T&gt; s);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>Subscriber</code> subscribes to a <code>Publisher&lt;T&gt;</code>, receiving notifications on any new values of type <code>T</code> through its <code>onNext(T)</code> method. If there are any errors, its <code>onError(Throwable)</code> method is called. When processing has completed normally, the subscriber&#8217;s <code>onComplete</code> method is called.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. the Reactive Streams <code>Subscriber&lt;T&gt;</code>.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.reactivestreams;

public interface Subscriber&lt;T&gt; {

    public void onSubscribe(Subscription s);

    public void onNext(T t);

    public void onError(Throwable t);

    public void onComplete();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When a <code>Subscriber</code> first connects to a <code>Publisher</code>, it is given a <code>Subscription</code> in the <code>Subscriber#onSubscribe</code> method. The <code>Subscription</code> is arguably the most important part of the whole specification: it enables backpressure. The <code>Subscriber</code> uses the <code>Subscription#request</code> method to request more data or the <code>Subscription#cancel</code> method to halt processing.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. The Reactive Streams <code>Subscription&lt;T&gt;</code>.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.reactivestreams;

public interface Subscription {

    public void request(long n);

    public void cancel();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The Reactive Streams specification provides <em>one</em> more useful, albeit obvious, type:  A <code>Processor&lt;A,B&gt;</code>  is a simple interface that extends both <code>Subscriber&lt;A&gt;</code> and a <code>Publisher&lt;B&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. The Reactive Streams <code>Processor&lt;T&gt;</code>.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.reactivestreams;

public interface Processor&lt;T, R&gt; extends Subscriber&lt;T&gt;, Publisher&lt;R&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The specification is not meant to be a prescription for the implementations,   instead defining types for interoperability. The Reactive Streams types are so obviously useful that they <em>_eventually</em> found their way into the recent Java 9 release as one-to-one semantically equivalent interfaces in the <code>java.util.concurrent.Flow</code> class, e.g.: <code>java.util.concurrent.Flow.Publisher</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactor">Reactor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Reactive Streams types are not enough; you&#8217;ll need higher order implementations to support operations like filtering and transformation. Pivotal&#8217;s Reactor project is a good choice here; it builds on top of the Reactive Streams specification. It provides two specializations of   <code>Publisher&lt;T&gt;</code>. The first, <code>Flux&lt;T&gt;</code>, is a <code>Publisher</code> that produces zero or more values. It&#8217;s unbounded. The second, <code>Mono&lt;T&gt;</code>, is a <code>Publisher&lt;T&gt;</code> that produces zero or one value. They&#8217;re both publishers and you can treat them that way, but they go much further than the  Reactive Streams specification. They both provide operators, ways to  process a stream of values. Reactor types compose nicely - the output of one thing can be the input to another and if a type needs to work with other streams of data, they rely upon <code>Publisher&lt;T&gt;</code> instances.</p>
</div>
<div class="paragraph">
<p>Both <code>Mono&lt;T&gt;</code> and <code>Flux&lt;T&gt;</code> implement <code>Publisher&lt;T&gt;</code>; our recommendation is that your methods accept <code>Publisher&lt;T&gt;</code> instances but return <code>Flux&lt;T&gt;</code> or <code>Mono&lt;T&gt;</code> to help the client distinguish the kind of data its being given. Suppose you&#8217;re given a <code>Publisher&lt;T&gt;</code> and asked to render a user-interface for that <code>Publisher&lt;T&gt;</code>. Should you render a detail page for one record, as you might were you given a <code>CompletableFuture&lt;T&gt;</code>? Or should you render an overview page, with a list or grid displaying <em>all</em> the records in a paged fashion? It&#8217;s hard to know. <code>Flux&lt;T&gt;</code> and <code>Mono&lt;T&gt;</code>, on the other hand, are very specific. You know to render an overview page if you&#8217;re given a <code>Flux&lt;T&gt;</code> and a detail page for one (or no) record when given a <code>Mono&lt;T&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Reactor is a Pivotal project; it&#8217;s become very popular. Facebook use it in their <a href="https://github.com/rsocket/rsocket-java">reactive RPC mechanism, RSocket</a>, led by RxJava creator Ben Christensen. Salesforce use it in their <a href="https://github.com/salesforce/reactive-grpc">reactive gRPC implementation</a>. It implements the Reactive Streams types, and so can interoperate with other technologies that support those types like <a href="https://github.com/ReactiveX/RxJava/blob/2.x/src/main/java/io/reactivex/Flowable.java">Netflix&#8217;s RxJava 2</a>, <a href="https://doc.akka.io/docs/akka/current/stream/operators/Sink/asPublisher.html#aspublisher">Lightbend&#8217;s Akka Streams</a>, and <a href="https://vertx.io/docs/vertx-reactive-streams/java/">the Eclipse Foundation&#8217;s Vert.x project</a>. David Karnok, lead of RxJava 2, has worked extensively with Pivotal on Reactor, too, making it even better.  And, of course, it&#8217;s been in Spring Framework in some form or another since Spring Framework 4.0.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_spring">Reactive Spring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As useful as project Reactor is, it&#8217;s only a foundation. Our applications need to talk to data sources. They need to produce and consume HTTP, SSE and WebSocket endpoints. They will need to support authentication and authorization. Spring provides these things. If Reactor gives us the missing metaphor, Spring helps us all speak the same language.</p>
</div>
<div class="paragraph">
<p>Spring Framework 5.0 was released in September 2017. It builds on Reactor and the Reactive Streams specification. It includes a new reactive runtime and component model called <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web-reactive.html#webflux">Spring WebFlux</a>. Spring WebFlux does not depend on or require the Servlet APIs to work. It ships with adapters that allow it to work on top of a Servlet-engine, if need be, but it&#8217;s not required. It also provides a net new Netty-based web server. Spring Framework 5, which works with a baseline of Java 8 and Java EE 7,  is now the baseline for much of the Spring ecosystem including Spring Data Kay, Spring Security 5, Spring Boot 2 and Spring Cloud Finchley.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s build something! We&#8217;ll begin our journey, as usual, at my second <a href="http://start.Spring.io">favorite place on the internet, the Spring Initializr -  start.Spring.io</a>. The goal here is to build a new reactive web application that supports reactive data access, and then secure it (reactively!). Select the following dependencies either by using the combo box on the bottom right of the page or by selecting "Switch to the Full Version" and then choosing <code>DevTools</code>, <code>Reactive Web</code>, <code>Reactive MongoDB</code>. and <code>Lombok</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/the-spring-initializr.png" alt="the Spring Initializr" width="1000">
</div>
<div class="title">Figure 1. Selections on the Spring Initializr for a new, reactive application.</div>
</div>
<div class="paragraph">
<p>This will give you a new project with the following layout.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. The generated project structure.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.
 mvnw
 mvnw.cmd
 pom.xml
 src
     main
      java
       com
           example
               demo
                   DemoApplication.java
      resources
          application.properties
     test
         java
             com
                 example
                     demo
                         DemoApplicationTests.java

12 directories, 6 files</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Our Maven build file, <code>pom.xml</code>, is pretty plain, but it assumes we&#8217;re going to use JUnit 4. Let&#8217;s upgrade JUnit to use JUnit 5, which is a more modern testing framework that&#8217;s well supported by Spring Framework 5 and beyond. This owes in no small part to the fact that the lead of JUnit 5, Sam Brennan, is also the lead of the Spring Test framework. Add the following dependencies to your new application&#8217;s build file, <code>pom.xml</code>: <code>org.junit.jupiter</code>:`junit-jupiter-engine` and give it a <code>scope</code> of <code>test</code>. Then, exclude the <code>junit</code>:`junit` dependency from the <code>spring-boot-starter-test</code> dependency.  As of this writing, in September 2018, you <em>also</em> need to manually update the version of the Failsafe and Surefire Maven plugins in your Maven build&#8217;s <code>properties</code> stanza. This is the resulting Maven <code>pom.xml</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. <code>pom.xml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;reactive-web&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;

    &lt;name&gt;reactive-web&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.0.4.RELEASE&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;

    &lt;properties&gt;

        &lt;maven-failsafe-plugin.version&gt;2.22.0&lt;/maven-failsafe-plugin.version&gt;
        &lt;maven-surefire-plugin.version&gt;2.22.0&lt;/maven-surefire-plugin.version&gt;

        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;

    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-mongodb-reactive&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;de.flapdoodle.embed&lt;/groupId&gt;
            &lt;artifactId&gt;de.flapdoodle.embed.mongo&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;junit&lt;/groupId&gt;
                    &lt;artifactId&gt;junit&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
            &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;


&lt;/project&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is a stock-standard Spring Boot application with a <code>public static void main(String [] args)</code> entry-point class, <code>DemoApplication.java</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. <code>src/main/java/com/example/demo/DemoApplication.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DemoApplication {

		public static void main(String[] args) {
				SpringApplication.run(DemoApplication.class, args);
		}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s also an empty configuration file, <code>src/main/resources/application.properties</code>.</p>
</div>
<div class="paragraph">
<p>We&#8217;re ready to get started! Let&#8217;s turn to the first concern, data access.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_data_access">Reactive Data Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We want to talk to a natively reactive data store. That is, the driver for the database needs to itself support asynchronous IO, otherwise we won&#8217;t be able to scale out reads without scaling out threads, which defeats the point. Spring Data, an umbrella data access framework, supports a number of reactive data access options including reactive Cassandra, reactive MongoDB, reactive Couchbase and reactive Redis. We&#8217;ve chosen MongoDB, so make sure you have a MongoDB database instance running on your local machine on the default host, port, and accessible with the default username and password. If you&#8217;re on a Mac, you can use <code>brew install mongodb</code>.</p>
</div>
<div class="paragraph">
<p>MongoDB is a document database, so the unit of interaction is a sparse document - think of it as a JSON stanza that gets persistd and is retreivable by a key, the document ID.</p>
</div>
<div class="paragraph">
<p>Our application will support manipulating <code>Profile</code> objects. We&#8217;re going to persist <code>Profile</code> entities (reactively) using a reactive Spring Data repository, as documents in MongoDB. Let&#8217;s first look at the entity definition. It&#8217;s got one field, <code>email</code>, that will be persisted in MongoDB, and another field that will act as the document ID.</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. <code>src/main/java/com/example/demo/Profile.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Document 	<b class="conum">(1)</b>
@Data <b class="conum">(2)</b>
@AllArgsConstructor
@NoArgsConstructor
class Profile {

		@Id <b class="conum">(3)</b>
		private String id;

		<b class="conum">(4)</b>
		private String email;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>@Document</code> identifies the entity as a document to be persisted in MongoDB</p>
</li>
<li>
<p><code>@Data</code>, <code>@AllArgsConstructor</code>, and <code>@NoArgsConstructor</code> are all from Lombok. They&#8217;re compile-time  annotations that tell Lombok to synthesize getters/setters, constructors, a <code>toString</code>  method and an <code>equals</code> method.</p>
</li>
<li>
<p><code>@Id</code> is a Spring Data annotation that identifies the document ID for this document</p>
</li>
<li>
<p>..and finally, this field <code>email</code> is the thing that we want to store and retreive later.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>In order to persist documents of type <code>Profile</code>, we declaratively define a repository. A repository, a design pattern from Eric Evans' seminal tome, <em>Domain Driven Design</em>, is a way of encapsulating  object persistence. Repositories are responsible for persisting entities and value types. They present clients with a simple model for obtaining persistent objects and managing their life cycle. They decouple application and domain design from persistence technology and strategy choices. They also communicate design decision sabout object access. And, finally, they allow easy substitiion of implementation with a dummy implemenetation, ideal in testing. Spring Data&#8217;s repositories support all these goals with interface definitions whose implementation are satisfied by the framework at startup time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at our trivial Spring Data repisitory, <code>src/main/java/com/example/demo/ProfileRepository.java</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. <code>src/main/java/com/example/demo/ProfileRepository.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.data.mongodb.repository.ReactiveMongoRepository;

interface ProfileRepository extends ReactiveMongoRepository&lt;Profile, String&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Our repository extends the Spring Data-provided <code>ReactiveMongoRepository</code> interface which in turn provides a number of data access methods supporting reads, writes, deletes and searches, almost all in terms of method signatures accepting or returning <code>Publisher&lt;T&gt;</code> types.</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. <code>org.springframework.data.mongodb.repository.ReactiveMongoRepository</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.springframework.data.mongodb.repository;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import org.reactivestreams.Publisher;
import org.springframework.data.domain.Example;
import org.springframework.data.domain.Sort;
import org.springframework.data.repository.NoRepositoryBean;
import org.springframework.data.repository.query.ReactiveQueryByExampleExecutor;
import org.springframework.data.repository.reactive.ReactiveSortingRepository;

@NoRepositoryBean
public interface ReactiveMongoRepository&lt;T, ID&gt; extends ReactiveSortingRepository&lt;T, ID&gt;, ReactiveQueryByExampleExecutor&lt;T&gt; {

	&lt;S extends T&gt; Mono&lt;S&gt; insert(S entity);

	&lt;S extends T&gt; Flux&lt;S&gt; insert(Iterable&lt;S&gt; entities);

	&lt;S extends T&gt; Flux&lt;S&gt; insert(Publisher&lt;S&gt; entities);

	&lt;S extends T&gt; Flux&lt;S&gt; findAll(Example&lt;S&gt; example);

	&lt;S extends T&gt; Flux&lt;S&gt; findAll(Example&lt;S&gt; example, Sort sort);

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring Data will create an object that implements all these methods. It will provide an object for us that we can inject into into other objects to handle persistence.   If you define an empty repository, as we have, then there&#8217;s little reason to test the repository implementation. It&#8217;ll "just work."</p>
</div>
<div class="paragraph">
<p>Spring Data repositories also supports custom queries. We could, for example, define a custom finder method, of the form <code>Flux&lt;Profile&gt; findByEmail(String email)</code>, in our <code>ProfileRepository</code>  and  this would result in a method being defined that looks for all documents in MongoDB with a predicate that matches the <code>email</code> attribute in the document to the parameter, <code>email</code>, in the method name. If you define custom queries, then this might be an appropriate thing to test.</p>
</div>
<div class="paragraph">
<p>This is a sample application, of course, so we need some sample data with which to work. Let&#8217;s run some initialization logic when the application starts up. We can define a bean of type <code>ApplicationListener&lt;ApplicationReadyEvent&gt;</code> to be a consumer of an  <code>ApplicationContextEvent</code>, <code>ApplicationReadyEvent</code>, when the application starts us. This will be an enviable opportunity for us to write some sample data into the databse once the application&#8217;s started up.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. <code>src/main/java/com/example/demo/SampleDataInitializer.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.extern.log4j.Log4j2;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;

import java.util.UUID;

@Log4j2 <b class="conum">(1)</b>
@Component
@org.springframework.context.annotation.Profile("demo")<b class="conum">(2)</b>
class SampleDataInitializer
	implements ApplicationListener&lt;ApplicationReadyEvent&gt; {

		private final ProfileRepository repository; <b class="conum">(3)</b>

		public SampleDataInitializer(ProfileRepository repository) {
				this.repository = repository;
		}

		@Override
		public void onApplicationEvent(ApplicationReadyEvent event) {

				repository
					.deleteAll() <b class="conum">(4)</b>
					.thenMany(
						Flux
							.just("A", "B", "C", "D")<b class="conum">(5)</b>
							.map(name -&gt; new Profile(UUID.randomUUID().toString(), name + "@email.com")) <b class="conum">(6)</b>
							.flatMap(repository::save) <b class="conum">(7)</b>
					)
					.thenMany(repository.findAll()) <b class="conum">(8)</b>
					.subscribe(profile -&gt; log.info("saving " + profile.toString())); <b class="conum">(9)</b>
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>a Lombok annotation that results in the creation of a <code>log</code> field that is a Log4J logger being added to the class</p>
</li>
<li>
<p>this bean initializes sample data that is only useful for a demo. We don&#8217;t want this sample data being initialized every time. Spring&#8217;s <code>Profile</code> annotation tags an object for initialization only when the profile that matches the profile specified in the annotation is specifically activated.</p>
</li>
<li>
<p>we&#8217;ll use the <code>ProfileRepository</code> to handle persistence</p>
</li>
<li>
<p>here we start a reactive pipeline by first deleting everything in the databse. This operation returns a <code>Mono&lt;T&gt;</code>. Both <code>Mono&lt;T&gt;</code> and <code>Flux&lt;T&gt;</code> support chanining processing with the <code>thenMany(Publisher&lt;T&gt;)</code> method. So, after the <code>deleteAll()</code> method completes, we then want to process the writes of new data to the datbase.</p>
</li>
<li>
<p>we use  Reactor&#8217;s <code>Flux&lt;T&gt;.just(T&#8230;&#8203;)</code> factory method to create a new <code>Publisher</code> with a static list of <code>String</code> records, in-memory..</p>
</li>
<li>
<p>..and we transform each record in turn into a <code>Profile</code> object..</p>
</li>
<li>
<p>..that we then persist to the databse using our repository</p>
</li>
<li>
<p>After all the data has been written to the database, we want to fetch all the records from the database to confirm what we have there</p>
</li>
<li>
<p>If we&#8217;d stopped at the previous line, the <code>save</code> operation, and run this program then we would see.. nothing! <code>Publisher&lt;T&gt;</code>  instances are <em>lazy</em> - you need to <code>subscribe()</code> to them to trigger their execution. This last line is where the rubber meets the road. In this case, we&#8217;re using the <code>subscribe(Consumer&lt;T&gt;)</code> variant that lets us visit every record returned from the <code>repository.findAll()</code> operation and print out the record.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can activate a Spring profile with a command line switch, <code>-Dspring.profiles.active=foo</code> where <code>foo</code> is the name of the profile you&#8217;d like to activate. You can also set an environment variable, <code>export SPRING_PROFILES_ACTIVE=foo</code> before running the <code>java</code> process for your Spring Boot application.
</td>
</tr>
</table>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You&#8217;ll note that in the previous example we use two methods, <code>map(T)</code> and <code>flatMap(T)</code>. Map should be familiar if you&#8217;ve ever used the Java 8 <code>Stream</code> API. Map visits each record in a publisher and passes it through a lambda function which must transform it. The output of that transformation is then returned and accumulated into a new <code>Publisher</code>. So, the intermediate type after we return from our <code>map</code> operation is a <code>Publisher&lt;Profile&gt;</code>. In the next line we then call <code>flatMap</code>. <code>flatMap</code> is just like <code>map</code>, except that it unpacks the return value of the lambda given if the value is itself contained in a <code>Publisher&lt;T&gt;</code>. In our case, the <code>repository.save(T)</code> method returns a <code>Mono&lt;T&gt;</code>. If we&#8217;d used <code>.map</code> instead of <code>flatMap(T)</code>, we&#8217;d have a <code>Flux&lt;Mono&lt;T&gt;&gt;</code>, when what we really want is a <code>Flux&lt;T&gt;</code>. We can cleanly solve this problem usig <code>flatMap</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_reactive_service">A Reactive Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to use the repository to implement a service that will contain any course grained business logic. In the beginning a lot of the business logic will be pass through logic delegating to the repository, but we can add things like validation and integration with other systems at this layer. Let&#8217;s look at a simple service.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. <code>src/main/java/com/example/demo/ProfileService.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.extern.log4j.Log4j2;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Log4j2 <b class="conum">(1)</b>
@Service
class ProfileService {

		private final ApplicationEventPublisher publisher; <b class="conum">(2)</b>
		private final ProfileRepository profileRepository; <b class="conum">(3)</b>

		ProfileService(ApplicationEventPublisher publisher, ProfileRepository profileRepository) {
				this.publisher = publisher;
				this.profileRepository = profileRepository;
		}

		public Flux&lt;Profile&gt; all() { <b class="conum">(4)</b>
				return this.profileRepository.findAll();
		}

		public Mono&lt;Profile&gt; get(String id) { <b class="conum">(5)</b>
				return this.profileRepository.findById(id);
		}

		public Mono&lt;Profile&gt; update(String id, String email) { <b class="conum">(6)</b>
				return this.profileRepository
					.findById(id)
					.map(p -&gt; new Profile(p.getId(), email))
					.flatMap(this.profileRepository::save);
		}

		public Mono&lt;Profile&gt; delete(String id) {<b class="conum">(7)</b>
				return this.profileRepository
					.findById(id)
					.flatMap(p -&gt; this.profileRepository.deleteById(p.getId()).thenReturn(p));
		}

		public Mono&lt;Profile&gt; create(String email) {<b class="conum">(8)</b>
				return this.profileRepository
					.save(new Profile(null, email))
					.doOnSuccess(profile -&gt; this.publisher.publishEvent(new ProfileCreatedEvent(profile)));
		}

}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This tells Lombok to create a <code>log</code> field that is a Log4J logger.</p>
</li>
<li>
<p>we&#8217;ll want to publish events to other beans managed in the Spring <code>ApplicationContext</code>. Earlier, we defined an <code>ApplicationListener&lt;ApplicationReadyEvent&gt;</code> that listened for an event that was published in the <code>ApplicationContext</code>. Now, we&#8217;re going to publish an event for consumption of other beans of our devices in the <code>ApplicationContext</code>.</p>
</li>
<li>
<p>we defer to our repository to</p>
</li>
<li>
<p>..find all documents or..</p>
</li>
<li>
<p>..find a document by its ID..</p>
</li>
<li>
<p>..update a <code>Profile</code> and give it a new <code>email</code>..</p>
</li>
<li>
<p>..delete a record by its <code>id</code>..</p>
</li>
<li>
<p>..or create a new <code>Profile</code> in the database and publish an <code>ApplicationContextEvent</code>, one of our own creation called <code>ProfileCreatedEvent</code>, on successful write to the database. The <code>doOnSuccess</code> callback takes a <code>Consumer&lt;T&gt;</code> that gets invoked after the data in the reactive pipeline has been written to the database. We&#8217;ll see later why this event is so useful.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>ProfileCreatedEvent</code> is just like any other Spring <code>ApplicationEvent</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. <code>src/main/java/com/example/demo/ProfileCreatedEvent.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.context.ApplicationEvent;

public class ProfileCreatedEvent extends ApplicationEvent {

		public ProfileCreatedEvent(Profile source) {
				super(source);
		}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That wasn&#8217;t so bad, was it? Our service was pretty straightforward. The only novelty was the publishing of an event. Everything should be working just fine now. But, of course, we can&#8217;t possibly know that unless we test it.</p>
</div>
<div class="sect2">
<h3 id="_testing_our_reactive_service">Testing our Reactive Service</h3>
<div class="paragraph">
<p>Reactive code presents some subtle issues when testing. Remember, our code is asynchronous. It&#8217;s possibly concurrent. Each <code>Subscriber&lt;T&gt;</code> could execute on a different thread because the pipeline is managed by a <code>Scheduler</code>. You can change which scheduler is to be used by calling <code>(Flux,Mono).subscribeOn(Scheduler)</code>. There&#8217;s a convenient factory, <code>Schedulers.\*</code>, that lets you build a new <code>Scheduler</code> from, for example, a <code>java.util.concurrent.Executor</code>. You don&#8217;t normally need to override the <code>Scheduler</code>, though. By default there&#8217;s one thread per core and the scheduler will just work. You only really need to worry about it when the thing to which you&#8217;re subscribing could end up blocking. If, for example, you end up making a call to a blocking JDBC datastore in your <code>Publisher&lt;T&gt;</code>, then you should scale up interactions with that datastore with more threads using a <code>Scheduler</code>.</p>
</div>
<div class="paragraph">
<p>You need to understand that the <code>Scheduler</code> is present because it implies asynchronocity. This asynchronicity and concurrency is deterministic if you use the operators in the Reactor API: things  <em>will</em> execute as they should. It&#8217;s only ever problematic, or inscrutable, when attempting to poke at the state of the reactive pipeline from outside. Then things get a bit twisted.  Reactor ships with some very convenient testing support that allow you to assert things about reactive <code>Publisher&lt;T&gt;</code> instances - what is going to be created and when - without having to worry about the schedulers. Let&#8217;s look at some tests using the <code>StepVerifier</code> facility.</p>
</div>
<div class="paragraph">
<p>In order for us to appreciate what&#8217;s happening here, we need to take a moment and step back and revisit <em>test slices</em>. Test slices are a feature in Spring Boot that allow the client to laod the types in a Spring <code>ApplicationContext</code> that are adjacent to the thing under test. In this case, we&#8217;re interested in testing the data access logic in the service. We are <em>not</em> interested in testing the web functionality. We haven&#8217;t even written the web functionality yet, for a start! A test slice lets us tell Spring Boot to load nothing by defdault and then we can bring pieces back in iteratively.</p>
</div>
<div class="paragraph">
<p>When Spring Boot starts up it runs a slew of auto-configuration classes. Classes that produce objects that Spring in turn manages for us. The objects are provided by default assuming certain conditions are met. These conditions can include all sorts of things, like the presence of certain types on the classpath, properties in Spring&#8217;s <code>Environment</code>, and more. When a Spring Boot application starts up, it is the sum of all the auto-configurations and user configuration given to it. It will be, for our application, database connectivity, object-record mapping (ORM), a webserver, and so much more.</p>
</div>
<div class="paragraph">
<p>We only need the machinery related to  MongoDB and our <code>ProfileService</code>, in isolation. We&#8217;ll use the  <code>@DataMongoTest</code> annotation to tell Spring Boot to autoconfigure all the things that could be implied in our MongoDB logic, while ignoring things like the web server,  runtime and web components. This results in focused, faster test code that has the benefit of being easier to reproduce. The <code>@DataMongoTest</code> annotation is what&#8217;s called a <em>test slice</em> in the Spring Boot world. It supports testing a <em>slice</em> of our application&#8217;s functionality in isolation. There are numerous other test slices and you can easily create your own, too.</p>
</div>
<div class="paragraph">
<p>Test slices can also contribute <em>new</em> auto-configuration supporting tests, specifically. The <code>@DataMongoTest</code> does this. It can even run an <em>embedded</em> MongoDB instance using the Flapdoodle library! Let&#8217;s take advantage of this. Add the following to your Maven build <code>de.flapdoodle.embed</code> : <code>de.flapdoodle.embed.mongo</code> with scope <code>test</code>. There&#8217;s no need to specify a version; Spring Boot will manage that for us.</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. <code>src/test/java/com/example/demo/ProfileServiceTest.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.data.mongo.DataMongoTest;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.junit.jupiter.SpringExtension;
import org.springframework.util.StringUtils;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

import java.util.UUID;
import java.util.function.Predicate;

@Log4j2
@DataMongoTest <b class="conum">(1)</b>
@Import(ProfileService.class) <b class="conum">(2)</b>
@ExtendWith(SpringExtension.class)  <b class="conum">(3)</b>
public class ProfileServiceTest {

		private final ProfileService service;
		private final ProfileRepository repository;

		public ProfileServiceTest(@Autowired ProfileService service, <b class="conum">(4)</b>
																												@Autowired ProfileRepository repository) {
				this.service = service;
				this.repository = repository;
		}

		@Test <b class="conum">(5)</b>
		public void getAll() {

				Flux&lt;Profile&gt; saved = repository.saveAll(Flux.just(new Profile(null, "Josh"), new Profile(null, "Matt"), new Profile(null, "Jane")));

				Flux&lt;Profile&gt; composite = service.all().thenMany(saved);

				Predicate&lt;Profile&gt; match = profile -&gt; saved.any(saveItem -&gt; saveItem.equals(profile)).block();

				StepVerifier
					.create(composite) <b class="conum">(6)</b>
					.expectNextMatches(match)  <b class="conum">(7)</b>
					.expectNextMatches(match)
					.expectNextMatches(match)
					.verifyComplete(); <b class="conum">(8)</b>
		}

		@Test
		public void save() {
				Mono&lt;Profile&gt; profileMono = this.service.create("email@email.com");
				StepVerifier
					.create(profileMono)
					.expectNextMatches(saved -&gt; StringUtils.hasText(saved.getId()))
					.verifyComplete();
		}

		@Test
		public void delete() {
				String test = "test";
				Mono&lt;Profile&gt; deleted = this.service
					.create(test)
					.flatMap(saved -&gt; this.service.delete(saved.getId()));
				StepVerifier
					.create(deleted)
					.expectNextMatches(profile -&gt; profile.getEmail().equalsIgnoreCase(test))
					.verifyComplete();
		}

		@Test
		public void update() throws Exception {
				Mono&lt;Profile&gt; saved = this.service
					.create("test")
					.flatMap(p -&gt; this.service.update(p.getId(), "test1"));
				StepVerifier
					.create(saved)
					.expectNextMatches(p -&gt; p.getEmail().equalsIgnoreCase("test1"))
					.verifyComplete();
		}

		@Test
		public void getById() {
				String test = UUID.randomUUID().toString();
				Mono&lt;Profile&gt; deleted = this.service
					.create(test)
					.flatMap(saved -&gt; this.service.get(saved.getId()));
				StepVerifier
					.create(deleted)
					.expectNextMatches(profile -&gt; StringUtils.hasText(profile.getId()) &amp;&amp; test.equalsIgnoreCase(profile.getEmail()))
					.verifyComplete();
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the Spring Boot test slice for MongoDB testing</p>
</li>
<li>
<p>we want to add, in addition to all the MongoDB functionality, our custom service for testing</p>
</li>
<li>
<p>This annotation tells JUnit 5 to involve the <code>SpringExtension</code> class when running this test. <code>SpringExtension</code> in turn manages instances of the class under test. We can easily inject dependencies from Sprign into our test classes. We can even inject them into the constructor! The extension is what integrates Spring with JUnit 5.</p>
</li>
<li>
<p>Look ma! Constructor injection in a unit test!</p>
</li>
<li>
<p>Make sure you&#8217;re using the new <code>org.junit.jupiter.api.Test</code> annotation from JUnit 5..</p>
</li>
<li>
<p>In this unit test we setup state in one publisher (<code>saved</code>)..</p>
</li>
<li>
<p>..and then assert things about that state in the various <code>expectNextMatches</code> calls.</p>
</li>
<li>
<p>Make sure to call <code>verifyComplete</code>! Otherwise, nothing&#8217;ll happen.. and that makes me sad.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>We only annotated one test because the rest are unremarkable and similiar.</p>
</div>
<div class="paragraph">
<p>The <code>StepVerifier</code> is central to testing all things reactive. It gives us a way to assert that what we think is going to come next in the publisher is in fact going to come next in the publisher. The <code>StepVerifier</code> provides several variants on the <code>expect*</code> theme. Think of this as the reactive equivalent to <code>Assert*</code>.</p>
</div>
<div class="paragraph">
<p>JUnit 5 supports the same lifecycle methods and annotations (like <code>@Before</code>) as JUnit 4. This is great because it gives you a single place to set up all tests in a class, or to tear down the machinery between tests. In reactive tests, however, those  That said, I wouldn&#8217;t <em>subscribe</em> to any reactive initialization pipelines in the <code>setUp</code>  method. Instead, you might define  a <code>Flux&lt;T&gt;</code> in the setup, and then compose it in the body of the test methods. This way, you don&#8217;t have to wonder if the setup has concluded before the tests themselves execute.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_web_the_final_frontier">The Web: the Final Frontier</h3>
<div class="paragraph">
<p>We&#8217;ve got a data tier and a service. Let&#8217;s stand up RESTful HTTP endpoints to facilitate access to the data. Spring has long had Spring MVC, a web framework that builds upon the  Servlet specification. Spring MVC  has this concept of a controller - a class that has   logic defined in handler methods that process incoming requests and then stage a response - usually a view or a representation of some server-side resource. In the Spring MVC architecture, requests come in to the web container, they&#8217;re routed to the right <code>Servlet</code> (in this case, the Spring MVC <code>DispatcherServlet</code>) and the <code>DispatcherServlet</code> then forwards the request to the right handler method in the right controller based on any of a number of things -  typically annotations on the handler methods which themselves live on controller object instances.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a classic Spring MVC style controller that supports manipulating our <code>Profile</code> entities.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. <code>src/main/java/com/example/demo/GreetingsRestController.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.reactivestreams.Publisher;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

import java.net.URI;


@RestController <b class="conum">(1)</b>
@RequestMapping(value = "/profiles", produces = MediaType.APPLICATION_JSON_VALUE)  <b class="conum">(2)</b>
@org.springframework.context.annotation.Profile("classic")
class ProfileRestController {

		private final MediaType mediaType = MediaType.APPLICATION_JSON_UTF8;
		private final ProfileService profileRepository;

		ProfileRestController(ProfileService profileRepository) {
				this.profileRepository = profileRepository;
		}

		<b class="conum">(3)</b>
		@GetMapping
		Publisher&lt;Profile&gt; getAll() {
				return this.profileRepository.all();
		}

		<b class="conum">(4)</b>
		@GetMapping("/{id}")
		Publisher&lt;Profile&gt; getById(@PathVariable("id") String id) {
				return this.profileRepository.get(id);
		}

		<b class="conum">(5)</b>
		@PostMapping
		Publisher&lt;ResponseEntity&lt;Profile&gt;&gt; create(@RequestBody Profile profile) {
				return this.profileRepository
					.create(profile.getEmail())
					.map(p -&gt; ResponseEntity.created(URI.create("/profiles/" + p.getId()))
						.contentType(mediaType)
						.build());
		}

		@DeleteMapping("/{id}")
		Publisher&lt;Profile&gt; deleteById(@PathVariable String id) {
				return this.profileRepository.delete(id);
		}

		@PutMapping("/{id}")
		Publisher&lt;ResponseEntity&lt;Profile&gt;&gt; updateById(@PathVariable String id, @RequestBody Profile profile) {
				return Mono
					.just(profile)
					.flatMap(p -&gt; this.profileRepository.update(id, p.getEmail()))
					.map(p -&gt; ResponseEntity
						.ok()
						.contentType(this.mediaType)
						.build());
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is yet another stereotype annotation that tells Spring WebFlux that this class provides HTTP handler methods</p>
</li>
<li>
<p>there are some attributes that are common to all the HTTP endpoints, like the root URI, and the default <code>content-type</code> of all responses produced. You can use <code>@RequestMapping</code> to spell this out at the class level and the configuration is inherited for each subordinate handler method</p>
</li>
<li>
<p>there are specializations of <code>@RequestMapping</code>, one for each HTTP verb, that you can use. This annotation says, "this endpoint is identical to that specified in the root <code>@RequestMapping</code> except that it is limited to HTTP <code>GET</code> endpoints"</p>
</li>
<li>
<p>this endpoint uses a <em>path variable</em> - a part of the URI that is matched against the incoming request and used to extract a parameter. In this case, it extracts the <code>id</code> parameter and makes it available as a method parameter in the handler method.</p>
</li>
<li>
<p>this method supports creating a new <code>Profile</code> with an HTTP <code>POST</code> action. In this handler method we expect incoming requests to have a JSON body that the framework then marhsals into a Java object, <code>Profile</code>.  This happens automtically based on the content-type of the incoming request and the configured, acceptable, convertable payloads supported by Spring WebFlux</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach is great if you have a lot of related endpoints that share common dependencies. You can collocate, for example, the <code>GET</code>, <code>PUT</code>, <code>POST</code>, etc., handler logic for a particular resource in one controller class so they can all use the same injected service or validation logic.  The controller approach is not new; Java web frameworks have been using something like it for <em>decades</em> now. The older among us will remember using Apache Struts in the dawn of the 00&#8217;s. This approach works well if you have a finite set of HTTP endopoints whose configuration is known a priori. It works well if you want to collocate related endpoints. It also works well if the request matching logic can be described declaratively using Spring&#8217;s various annotations.</p>
</div>
<div class="paragraph">
<p>This approach is also likely to be a perennial favorite for those coming from Spring MVC, as its familiar. Those annotations are exactly the same annotations from Spring MVC. But, this is <em>not</em> Spring MVC. And this isn&#8217;t, at least by default, the Servlet API. It&#8217;s a brand new web runtime, Spring WebFlux, running - in this instance  -  on Netty.</p>
</div>
<div class="paragraph">
<p>Spring Framework 5 changes things, though. Spring Framework 5 assumes a Java 8 baseline and with it   lambdas and endless, functional, possibilities! A lot of what we&#8217;re doing in a reactive web application lends itself to the functional programming style. Spring Framework 5 debuts a new functional reactive programming model that mirrors the controller-style programming model in Spring WebFlux. This new programming model is available exclusively in Spring WebFlux. Let&#8217;s look at an example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. <code>src/main/java/com/example/demo/ProfileEndpointConfiguration.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.server.RequestPredicate;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerResponse;

import static org.springframework.web.reactive.function.server.RequestPredicates.*;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;

@Configuration
class ProfileEndpointConfiguration {

		@Bean
		RouterFunction&lt;ServerResponse&gt; routes(ProfileHandler handler) { <b class="conum">(1)</b>
				return route(i(GET("/profiles")), handler::all) <b class="conum">(2)</b>
					.andRoute(i(GET("/profiles/{id}")), handler::getById)
					.andRoute(i(DELETE("/profiles/{id}")), handler::deleteById) <b class="conum">(3)</b>
					.andRoute(i(POST("/profiles")), handler::create)
					.andRoute(i(PUT("/profiles/{id}")), handler::updateById);
		}

		<b class="conum">(4)</b>
		private static RequestPredicate i(RequestPredicate target) {
				return new CaseInsensitiveRequestPredicate(target);
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is a Spring bean that describes routes and their handlers to the framework. The handler methods themselves are Java 8 references to methods on another injected bean. They could just as easily have been inline lambdas.</p>
</li>
<li>
<p>each route has a <code>RequestPredicate</code> (the object produced by <code>GET(..)</code> in this line) and a <code>HandlerFunction&lt;ServerResponse&gt;</code>.</p>
</li>
<li>
<p>This route uses a path variable, <code>{id}</code>, which the framework will use to capture a parameter in the URI string.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>We make judicious use of static imports in this example to make things as concise as possible. <code>RouterFunction&lt;ServerResponse&gt;</code> is a builder API. You can store the result of each call to <code>route</code> or <code>andRoute</code> in an intermediate variable if you like. You could loop through records in a for-loop from records in a database and contribute new endpoints dynamically, if you wanted.</p>
</div>
<div class="paragraph">
<p>Spring WebFlux provides a DSL for describing how to match incoming requests.  <code>GET("/profiles")</code> results in a <code>RequestPredicate</code> that matches incoming HTTP <code>GET</code>-method requests that are routed to the URI <code>/profiles</code>. You can compose <code>RequestPredicate</code> instances using <code>.and(RequestPredicate)</code>, <code>.not(RequestPredicate)</code>, or <code>.or(RequestPredicate)</code>. In this example, I also provide a fairly trivial adapter -  <code>CaseInsensitiveRequestPredicate</code> - that lower-cases all incoming URLs and matches it against the configured (and lower-cased) URI in the <code>RequestPredicate</code>. The result is that if you type <code><a href="http://localhost:8080/profiles" class="bare">http://localhost:8080/profiles</a></code> or <code><a href="http://localhost:8080/PROfiLEs" class="bare">http://localhost:8080/PROfiLEs</a></code> they&#8217;ll both work.</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. <code>src/main/java/com/example/demo/CaseInsensitiveRequestPredicate.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.http.server.PathContainer;
import org.springframework.web.reactive.function.server.RequestPredicate;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.support.ServerRequestWrapper;

import java.net.URI;

public class CaseInsensitiveRequestPredicate implements RequestPredicate {

		private final RequestPredicate target;

		CaseInsensitiveRequestPredicate(RequestPredicate target) {
				this.target = target;
		}

		@Override
		public boolean test(ServerRequest request) { <b class="conum">(1)</b>
				return this.target.test(new LowerCaseUriServerRequestWrapper(request));
		}

		@Override
		public String toString() {
				return this.target.toString();
		}
}

<b class="conum">(2)</b>
class LowerCaseUriServerRequestWrapper extends ServerRequestWrapper {

		LowerCaseUriServerRequestWrapper(ServerRequest delegate) {
				super(delegate);
		}

		@Override
		public URI uri() {
				return URI.create(super.uri().toString().toLowerCase());
		}

		@Override
		public String path() {
				return uri().getRawPath();
		}

		@Override
		public PathContainer pathContainer() {
				return PathContainer.parsePath(path());
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The meat of a  <code>RequestPredicate</code> implementation is in the <code>test(ServerRequest)</code> method.</p>
</li>
<li>
<p>My implementation wraps the incoming <code>ServerRequest</code>, a common enough task that Spring WebFlux even provides a <code>ServerRequestWrapper</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Once a request is matched, the <code>HandlerFunction&lt;ServerResponse&gt;</code> is invoked to produce a response. Let&#8217;s look at our handler object.</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. <code>src/main/java/com/example/demo/ProfileHandler.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.reactivestreams.Publisher;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.net.URI;

@Component
class ProfileHandler {

		<b class="conum">(1)</b>
		private final ProfileService profileService;

		ProfileHandler(ProfileService profileService) {
				this.profileService = profileService;
		}

		<b class="conum">(2)</b>
		Mono&lt;ServerResponse&gt; getById(ServerRequest r) {
				return defaultReadResponse(this.profileService.get(id(r)));
		}

		Mono&lt;ServerResponse&gt; all(ServerRequest r) {
				return defaultReadResponse(this.profileService.all());
		}

		Mono&lt;ServerResponse&gt; deleteById(ServerRequest r) {
				return defaultReadResponse(this.profileService.delete(id(r)));
		}

		Mono&lt;ServerResponse&gt; updateById(ServerRequest r) {
				Flux&lt;Profile&gt; id = r.bodyToFlux(Profile.class)
					.flatMap(p -&gt; this.profileService.update(id(r), p.getEmail()));
				return defaultReadResponse(id);
		}

		Mono&lt;ServerResponse&gt; create(ServerRequest request) {
				Flux&lt;Profile&gt; flux = request
					.bodyToFlux(Profile.class)
					.flatMap(toWrite -&gt; this.profileService.create(toWrite.getEmail()));
				return defaultWriteResponse(flux);
		}

		<b class="conum">(3)</b>
		private static Mono&lt;ServerResponse&gt; defaultWriteResponse(Publisher&lt;Profile&gt; profiles) {
				return Mono
					.from(profiles)
					.flatMap(p -&gt; ServerResponse
						.created(URI.create("/profiles/" + p.getId()))
						.contentType(MediaType.APPLICATION_JSON_UTF8)
						.build()
					);
		}

		<b class="conum">(4)</b>
		private static Mono&lt;ServerResponse&gt; defaultReadResponse(Publisher&lt;Profile&gt; profiles) {
				return ServerResponse
					.ok()
					.contentType(MediaType.APPLICATION_JSON_UTF8)
					.body(profiles, Profile.class);
		}

		private static String id(ServerRequest r) {
				return r.pathVariable("id");
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>as before, we&#8217;re going to make use of our <code>ProfileService</code> to do the heavy lifting</p>
</li>
<li>
<p>each handler method has an identical signature: <code>SeverRequest</code> is the request parameter and <code>Mono&lt;ServerResponse&gt;</code> is the return value.</p>
</li>
<li>
<p>we can centralize common logic in, yep! - you guessed it! - functions. This function creates a <code>Mono&lt;ServerResponse&gt;</code> from a <code>Publisher&lt;Profile&gt;</code> for any incoming request. Each request uses the <code>ServerResponse</code> builder object to create a response that has a <code>Location</code> header, a <code>Content-Type</code> header, and no payload. (You don&#8217;t need to send a payload in the response for <code>PUT</code> or <code>POST</code>, for example).</p>
</li>
<li>
<p>this method centralizes all configuration for replies to read requests (for instance, those coming from <code>GET</code> verbs)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Straightforward, right? I like this approach - the handler object centralizes processing for related resources into a single class, just like with the controller-style arrangement. We&#8217;re also able to centralize routing logic in the <code>@Configuration</code> class. This means it&#8217;s easier to see at a glance what routes have been configured. It&#8217;s easier to refactor routing. Routing is also now more dynamic. We can change how requests are matched, and we can dynamically contribute endpoints. The only drawback to this style is that your code is inextricably tied to the Spring WebFlux component model. Your handler methods in the <code>ProfileHandler</code> are, no question at all, tied to Spring WebFlux. From where I sit, that&#8217;s OK. A controller is supposed to be a thin adapter layer on top of your service. Most of the business logic lives in the service layer, or below. As we&#8217;ve already seen, we can easily unit test my service. And anyway, testing my HTTP endpoints requires something altogether different&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_htttp_endpoints">Testing the HTTTP Endpoints</h3>
<div class="paragraph">
<p>We&#8217;ve seen two implementations of the same HTTP endpoints in this application. The classic endpoints are annotated with <code>@Profile("classic")</code>  where as the functional reactive endpoints are annotated with <code>@Profile("default")</code>. If no other profile is active, any bean tagged with the <code>default</code> profile will be active. So, if you <em>don&#8217;t</em> specify <code>classic</code>, the <code>default</code> bean will activate. We should test both, even if they&#8217;re just for demonstration purposes. I&#8217;ve extracted all the tests into a base class that I&#8217;ll extend twice, activating each of the two profiles to test in isolation each of the HTTP endpoint styles.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s look at the base class, which contains the most important aspects of testing our HTTP endpoints. This base class is <code>abstract</code> -</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. <code>src/test/java/com/example/demo/ProfileEndpointsBaseClass.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mockito;
import org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.context.junit.jupiter.SpringExtension;
import org.springframework.test.web.reactive.server.WebTestClient;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Log4j2
@WebFluxTest <b class="conum">(1)</b>
@ExtendWith(SpringExtension.class)
public abstract class ProfileEndpointsBaseClass {

		private final WebTestClient client; <b class="conum">(2)</b>

		@MockBean  <b class="conum">(3)</b>
		private ProfileRepository repository;

		public ProfileEndpointsBaseClass(WebTestClient client) {
				this.client = client;
		}

		@Test
		public void getAll() {

				log.info("running  " + this.getClass().getName());

				<b class="conum">(4)</b>
				Mockito
					.when(this.repository.findAll())
					.thenReturn(Flux.just(new Profile("1", "A"), new Profile("2", "B")));

				<b class="conum">(5)</b>
				this.client
					.get()
					.uri("/profiles")
					.accept(MediaType.APPLICATION_JSON_UTF8)
					.exchange()
					.expectStatus().isOk()
					.expectHeader().contentType(MediaType.APPLICATION_JSON_UTF8)
					.expectBody()
					.jsonPath("$.[0].id").isEqualTo("1")
					.jsonPath("$.[0].email").isEqualTo("A")
					.jsonPath("$.[1].id").isEqualTo("2")
					.jsonPath("$.[1].email").isEqualTo("B");
		}

		@Test
		public void save() {
				Profile data = new Profile("123", UUID.randomUUID().toString() + "@email.com");
				Mockito
					.when(this.repository.save(Mockito.any(Profile.class)))
					.thenReturn(Mono.just(data));
				MediaType jsonUtf8 = MediaType.APPLICATION_JSON_UTF8;
				this
					.client
					.post()
					.uri("/profiles")
					.contentType(jsonUtf8)
					.body(Mono.just(data), Profile.class)
					.exchange()
					.expectStatus().isCreated()
					.expectHeader().contentType(jsonUtf8);
		}

		@Test
		public void delete() {
				Profile data = new Profile("123", UUID.randomUUID().toString() + "@email.com");
				Mockito
					.when(this.repository.findById(data.getId()))
					.thenReturn(Mono.just(data));
				Mockito
					.when(this.repository.deleteById(data.getId()))
					.thenReturn(Mono.empty());
				this
					.client
					.delete()
					.uri("/profiles/" + data.getId())
					.exchange()
					.expectStatus().isOk();
		}

		@Test
		public void update() {
				Profile data = new Profile("123", UUID.randomUUID().toString() + "@email.com");

				Mockito
					.when(this.repository.findById(data.getId()))
					.thenReturn(Mono.just(data));

				Mockito
					.when(this.repository.save(data))
					.thenReturn(Mono.just(data));

				this
					.client
					.put()
					.uri("/profiles/" + data.getId())
					.contentType(MediaType.APPLICATION_JSON_UTF8)
					.body(Mono.just(data), Profile.class)
					.exchange()
					.expectStatus().isOk();
		}

		@Test
		public void getById() {

				Profile data = new Profile("1", "A");

				Mockito
					.when(this.repository.findById(data.getId()))
					.thenReturn(Mono.just(data));

				this.client
					.get()
					.uri("/profiles/" + data.getId())
					.accept(MediaType.APPLICATION_JSON_UTF8)
					.exchange()
					.expectStatus().isOk()
					.expectHeader().contentType(MediaType.APPLICATION_JSON_UTF8)
					.expectBody()
					.jsonPath("$.id").isEqualTo(data.getId())
					.jsonPath("$.email").isEqualTo(data.getEmail());
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is a another test slice. This one will test only the web tier, ignoring all the data tier functionality.</p>
</li>
<li>
<p>This will also contribute a mock HTTP client, the <code>WebTestClient</code>, that we can use to exercise the HTTP endpoints. This is a <em>mock</em> client - it will not actually issue HTTP requests over the wire. The network stack is virtual. It&#8217;ll exercise our HTTP endpoints, and all the Spring machinery, without connecting a server socket.</p>
</li>
<li>
<p>As this is a test slice, focused only on the HTTP components in Spring, we&#8217;re going to run into a problem. Our HTTP controllers depend on our service, and our service in turn depends on the reactive Spring Data MongoDB repository. The repository is part of the data tier. We use the Spring Boot annotation, <code>@MockBean</code>, to tell Spring Boot to create a Mockito-backed mock of the same type and - most importantly - to either contribute the mock to the Spring <code>ApplicationContext</code> if a bean of the same type doesn&#8217;t already exist or to replace any bean of the same type with the mock in the Spring <code>ApplicationContext</code>.</p>
</li>
<li>
<p>Since it&#8217;s just a Mockito-backed mock, we use Mockito to preprogram the stub so that it&#8217;ll return the pre-programmed responses</p>
</li>
<li>
<p>Finally, we can use the <code>WebTestClient</code>. The <code>WebTestClient</code> lets us issue requests to our HTTP endpoints and then assert certain things about the response.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>WebTestClient</code> is quite powerful. It&#8217;s a test-centric alternative to the reactive <code>WebClient</code> in Spring WebFlux which is an honest-to-goodness reactive HTTP client. In this  example, we make an HTTP request to an endpoint, confirm that the returned status code and headers line up with expectations, and then use  JSON Path  to poke at the structure of the returned result.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<a href="https://github.com/json-path/JsonPath">JSON Path</a> is like XPath, a query language for declaratively traversing nodes in an XML document. It allows easy traversal of JSON stanzas. It also provides a predicate language which we can use to match.
</td>
</tr>
</table>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>HTTP is great for a request-reply centric interaction with a service. It makes it easy to interrogate the HTTP service and get a response. But what if we&#8217;re interested in listening to events? We don&#8217;t want to constantly poll - we&#8217;d rather the service tell us when something is happening. Our service supports creating and updating records. As a client to such a service, it&#8217;d be nice to have a firehose endpoint - but don&#8217;t tell Twitter that! We could subscribe to such an endpoint and update the client state whenever there&#8217;s a new record. We need a fully duplexed protocol to maintain a connection to the client and push data to the client from the service&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_websockets">Reactive WebSockets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remember those <code>ApplicationEvent</code> instances that we published when a new record was created? Our goal now is to connect those events to websockets so that whenever a new event is published, a client gets a websocket notification.</p>
</div>
<div class="paragraph">
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">Websockets</a> are a  compelling option. They enable two-way communication  - client-to-service and service-to-client - on a connection. The protocol is particularly relevant for our use case because it&#8217;s well supported in browsers. A client connects to a server, sending an HTTP GET request to upgrade the connection to a WebSocket from a simple HTTP request. This is known as handshaking. Once the handhsake is done, clients communicate in an encoded fashion over a different protocol.  It&#8217;s often used in web applications because it implies HTTP to initiate the discussion. Modern HTTP browsers like Google Chrome and Mozilla&#8217;s Firefox also support the protocol well, making it a snap to write a trivial JavaScript client that runs in an HTML page. (We&#8217;ll get to the HTML client in a bit!)</p>
</div>
<div class="paragraph">
<p>It&#8217;s trivial to speak Websockets in Spring. So far, we&#8217;ve used <code>Publisher&lt;T&gt;</code> instances to communicate HTTP requests and responses back and forth. When we use websockets, which is an asynchronous, bi-directional protocol - we&#8217;ll use.. (you guessed it!): <code>Publisher&lt;T&gt;</code> instances!</p>
</div>
<div class="paragraph">
<p>This is one of the nice things about Spring WebFlux. It&#8217;s easy to figure out where to go next and how to do it. When in doubt, use a <code>Publisher&lt;T&gt;</code>! If you want to send finite payloads to the client as JSON payloads in a REST endpoint, use a <code>Publisher&lt;T&gt;</code>! Want to do asynchronous, server-side push using server-sent events (<code>text/event-stream</code>)? Use a <code>Publisher&lt;T&gt;</code>! Want to communicate using websockets in a bi-directional fashion? Use a <code>Publisher&lt;T&gt;</code>! It&#8217;s much easier to simulate synchronous and blocking IO with an asynchronous API like the reactive streams types than it is to simulate asynchronous APIs with synchronous and blocking types. This is why enterprise application integration is typically done in terms of messaging systems, not RPC.</p>
</div>
<div class="paragraph">
<p>In Spring MVC you have a more two-sided system: some interactions with the client were synchronous and blocking, and that was the happy path. If you wanted to break out of that arrangement and do something that needs asynchronous IO, like websockets or server-sent events, then the programming model changed profoundly. You&#8217;d end up quickly mired in threads or at least threadpools and <code>Executor</code> instances, managing threading manually. In Spring WebFlux, you have <em>one kind of stuff</em>.</p>
</div>
<div class="paragraph">
<p>We need to wire up a few objects to get Spring to work well with websockets. This is fairly boilerplate but it&#8217;s also trivial. We need a <code>HandlerMapping</code>, a <code>WebSocketHandler</code>, and a <code>WebSocketHandlerAdapter</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the skeletal configuration in a configuration class, <code>WebSocketConfiguration</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. <code>src/main/java/com/example/demo/WebSocketConfiguration.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.log4j.Log4j2;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.HandlerMapping;
import org.springframework.web.reactive.handler.SimpleUrlHandlerMapping;
import org.springframework.web.reactive.socket.WebSocketHandler;
import org.springframework.web.reactive.socket.WebSocketMessage;
import org.springframework.web.reactive.socket.server.support.WebSocketHandlerAdapter;
import reactor.core.publisher.Flux;

import java.util.Collections;
import java.util.concurrent.Executor;
import java.util.concurrent.Executors;

@Log4j2
@Configuration
class WebSocketConfiguration {

		<b class="conum">(1)</b>
		@Bean
		Executor executor() {
				return Executors.newSingleThreadExecutor();
		}

		<b class="conum">(2)</b>
		@Bean
		HandlerMapping handlerMapping(WebSocketHandler wsh) {
				return new SimpleUrlHandlerMapping() {
						{
								<b class="conum">(3)</b>
								setUrlMap(Collections.singletonMap("/ws/profiles", wsh));
								setOrder(10);
						}
				};
		}

		<b class="conum">(4)</b>
		@Bean
		WebSocketHandlerAdapter webSocketHandlerAdapter() {
				return new WebSocketHandlerAdapter();
		}

		@Bean
		WebSocketHandler webSocketHandler(
			ObjectMapper objectMapper, <b class="conum">(5)</b>
			ProfileCreatedEventPublisher eventPublisher <b class="conum">(6)</b>
		) {

				Flux&lt;ProfileCreatedEvent&gt; publish = Flux
					.create(eventPublisher)
					.share(); <b class="conum">(7)</b>

				return session -&gt; {

						Flux&lt;WebSocketMessage&gt; messageFlux = publish
							.map(evt -&gt; {
									try {
											<b class="conum">(8)</b>
											return objectMapper.writeValueAsString(evt.getSource());
									}
									catch (JsonProcessingException e) {
											throw new RuntimeException(e);
									}
							})
							.map(str -&gt; {
									log.info("sending " + str);
									return session.textMessage(str);
							});

						return session.send(messageFlux); <b class="conum">(9)</b>
				};
		}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>we&#8217;ll use the custom <code>Executor</code> in a bit when we bridge our events to the reactive websocket stream</p>
</li>
<li>
<p>the <code>HandlerMapping</code> object tells Spring about what handlers are available and what their URLs should be. It sits below the annotation-centric componetn model that we&#8217;ve looked at before.</p>
</li>
<li>
<p>Here, we&#8217;re telling Spring WebFlux to map our <code>WebSocketHandler</code> to a particular URI, <code>/ws/profiles</code></p>
</li>
<li>
<p>the <code>WebSocketHandlerAdapter</code> bridges the websocket support in Spring WebFlux with Spring WebFlux&#8217;s general routing machinery</p>
</li>
<li>
<p>We&#8217;re going to manually marshal some objects and turn them into JSON to send back to the client</p>
</li>
<li>
<p>This dependency is where the rubber meets the road. We&#8217;ll revisit this in a bit. This is the thing that consumes our application events and forwards them to the reactive websocket stream. We&#8217;re using a special factory method, <code>Flux#create(Consumer&lt;? super FluxSink&lt;T&gt;&gt; emitter)</code>, to create and publish items from our  <code>Pubisher&lt;T&gt;</code> manually.</p>
</li>
<li>
<p>The <code>.share()</code> method is another operator in Reactor. Keep in mind, we&#8217;re going to have a potentially large number of clients listening to our websocket stream. Each one will need updates when there&#8217;s new data. We don&#8217;t want one client consuming the data in one publisher to deprive the other clients of seeing the same data. So, we want to <em>broadcast</em> all the events to multiple subscribers. There&#8217;s no reason multiple <code>Subscriber&lt;T&gt;</code> instances can&#8217;t subscribe to the same <code>Publisher&lt;T&gt;</code>, but without this operator they&#8217;d end up exclusively consuming records.</p>
</li>
<li>
<p>We&#8217;re almost there! The interesting code is in our <code>eventPublisher</code>. The resulting <code>Publisher&lt;ProfileCreatedEvent&gt;</code> will be shared and from there each subscriber needs to transform the data into a <code>Publisher&lt;WebSocketMessage&gt;</code> that Spring WebFlux will in turn transform into messages over the websocket protocol.</p>
</li>
<li>
<p>Don&#8217;t forget to call <code>session.send(Publisher&lt;WebSocketMessage)</code>! Otherwise none of this will work. :-) Or at least, that&#8217;s what I&#8217;m told. :cough: Not saying it happened to me, or anything.. 'course not..</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>All that was fairly straightforward, one hopes. Let&#8217;s look at the most important bit - the <code>ProfileCreatedEventPublisher</code>. This code was harder for me to write than it is for you to read. This component needs to act as a bridge; it needs to consume <code>ProfileCreatedEvent</code> events and then put them in an in-memory <code>BlockingQueue&lt;ProfileCreatedEvent&gt;</code> which our <code>Publisher&lt;WebSocketMessage&gt;</code> will drain in another thread.  There&#8217;s really not that much to it; what you need to understand is the <code>java.util.concurrent.BlockingQueue&lt;T&gt;</code> collection, more than anything. A <code>BlockingQueue&lt;T&gt;</code> is an interesting beast. If a consumer tries to drain an item from the queue, but the queue is empty, the queue will block until such time as a new item has been offered to the queue. This means we can simply loop forever, waiting for the next item to be added to the queue, and when it&#8217;s available our code will return and we can publish the event on the <code>FluxSink&lt;ProfileCreatedEvent&gt; sink</code> pointer we&#8217;ve been given when the <code>Flux</code> is first created. The <code>Consumer&lt;T&gt;.accept(FluxSink&lt;ProfileCreatedEvent&gt; sink)</code> method, in this case, is only called once when the application starts up and we try to create the <code>Flux</code> for the first time. In that callback we begin the while loop that will constantly try to drain the <code>BlockingQueue&lt;T&gt;</code>. This infinite, and un-ending while-loop <em>blocks</em>! Naturally. That&#8217;s the whole point. So, we manage that ourselves using the previously configured <code>java.util.concurrent.Executor</code> instance.</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. <code>src/main/java/com/example/demo/ProfileCreatedEventPublisher.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import org.springframework.context.ApplicationListener;
import org.springframework.stereotype.Component;
import org.springframework.util.ReflectionUtils;
import reactor.core.publisher.FluxSink;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.Executor;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.function.Consumer;

@Component
class ProfileCreatedEventPublisher implements
	ApplicationListener&lt;ProfileCreatedEvent&gt;, <b class="conum">(1)</b>
	Consumer&lt;FluxSink&lt;ProfileCreatedEvent&gt;&gt; { <b class="conum">(2)</b>

		private final Executor executor;
		private final BlockingQueue&lt;ProfileCreatedEvent&gt; queue =
			new LinkedBlockingQueue&lt;&gt;(); <b class="conum">(3)</b>

		ProfileCreatedEventPublisher(Executor executor) {
				this.executor = executor;
		}

		<b class="conum">(4)</b>
		@Override
		public void onApplicationEvent(ProfileCreatedEvent event) {
				this.queue.offer(event);
		}

 		@Override
		public void accept(FluxSink&lt;ProfileCreatedEvent&gt; sink) {
				this.executor.execute(() -&gt; {
						while (true)
								try {
										ProfileCreatedEvent event = queue.take(); <b class="conum">(5)</b>
										sink.next(event); <b class="conum">(6)</b>
								}
								catch (InterruptedException e) {
										ReflectionUtils.rethrowRuntimeException(e);
								}
				});
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>ApplicationListener&lt;ApplicationEvent&gt;</code> interface is a Spring Framework construction. It tells the framework that we want to be notified, via the  <code>onApplicationEvent(ProfileCreatedEvent)</code> method, of any new events published when a new <code>Profile</code> is created.</p>
</li>
<li>
<p>The <code>Consumer&lt;FluxSink&lt;ProfileCreatedEvent&gt;&gt;</code> construction is used when we create the <code>Flux&lt;T&gt;</code> with <code>Flux.create</code>. This bean is a Java 8 <code>Consumer&lt;T&gt;</code> that <em>accepts</em> an instance of a <code>FluxSink&lt;T&gt;</code>. A <code>FluxSink&lt;T&gt;</code> is a thing into which we can publish new items, however we may arrive at them. If you want to integrate the reactive world with non-reactive code in the outside world, use this construction. I can capture that reference and use it in another thread. For example, I could use it to capture events from Spring Integration, or from some messaging technology, or from <em>anything</em> else, in any other thread. I  need only call <code>sink.next(T)</code> and the <code>Subscriber&lt;T&gt;</code> instances subscribed to this <code>Publisher&lt;T&gt;</code>  will get the item  <code>T</code>.</p>
</li>
<li>
<p>the <code>LinkedBlockingQueue&lt;T&gt;</code> is a marvel of the collections classes in the JDK. <em>Thank you</em>, Josh Bloch, Neal Gafter and Doug Lea! &lt;3</p>
</li>
<li>
<p>when an event is published in our service, it is disseminated to any and all interested listeners, including this component which then offers the item into the <code>Queue&lt;T&gt;</code></p>
</li>
<li>
<p>the event loop couldn&#8217;t be simpler. We wait for new entries to appear int he <code>BlockingQueue&lt;T&gt;</code>..</p>
</li>
<li>
<p>..and as soon as they are, we tell our reactive stream about them by calling <code>FluxSink&lt;T&gt;.next(T)</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Whew! There are a few moving pieces here, but ultimately all we&#8217;re trying to do is get the <code>Publisher&lt;T&gt;</code> lined up in such a way that Spring WebFlux can connect it to the websocket protocol and to our clients. Speaking of..</p>
</div>
<div class="paragraph">
<p>You don&#8217;t really need much JavaScript to connect an HTML 5 client to a browser. As a stopgap, just to prove that things are working, let&#8217;s create the simplest of possible clients, a static <code>ws.html</code> page with some barebones JavaScript code.</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. <code>src/main/resources/static/ws.html</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Profile notification client
    &lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script lang="text/javascript"&gt;

    <b class="conum">(1)</b>
    var socket = new WebSocket('ws://localhost:8080/ws/profiles');

    <b class="conum">(2)</b>
    socket.addEventListener('message', function (event) {
      window.alert('message from server: ' + event.data);
    });

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>we use an <code>WebSocket</code> object in JavaScript, connecting to the <code>/ws/profiles</code>  endpoint in our Spring Boot application</p>
</li>
<li>
<p>..and whenever a new message arrives we show the JSON in a alert dialog</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Couldn&#8217;t be simpler! You can drive new results into the system using the following <code>curl</code> incantation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. <code>create.sh</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">#!/bin/bash
port=${1:-8080}

curl -H"content-type: application/json" -d'{"email":"random"}' http://localhost:${port}/profiles</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this will <code>POST</code> a new record into the API which will then trigger a websocket notification if you have the browser client open.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Open the <code>ws.htlm</code> page in the browser and then run that <code>create.sh</code> in your shell. I&#8217;m assuming you have <code>curl</code>. This is a trivial end-to-end and it&#8217;s satisfying to see it all come together. That said, we should definitely test this. You know. Just in case..</p>
</div>
<div class="sect2">
<h3 id="_testing_websockets">Testing WebSockets</h3>
<div class="paragraph">
<p>We just did an end-to-end test. And that&#8217;s satisfying! But, it&#8217;s not substitute for automation. Let&#8217;s write a test. This time, we want to exercise all the moving parts - the database, the HTTP endpoints, and the websocket support. We&#8217;re going to write more of an integration test than a unit test.</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. <code>src/test/java/com/example/demo/WebSocketConfigurationTest.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.demo;

import lombok.extern.log4j.Log4j2;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.reactivestreams.Publisher;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit.jupiter.SpringExtension;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.socket.WebSocketMessage;
import org.springframework.web.reactive.socket.WebSocketSession;
import org.springframework.web.reactive.socket.client.ReactorNettyWebSocketClient;
import org.springframework.web.reactive.socket.client.WebSocketClient;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.net.URI;
import java.util.UUID;
import java.util.concurrent.Executor;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicLong;

@Log4j2
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT) <b class="conum">(1)</b>
@ExtendWith(SpringExtension.class)
class WebSocketConfigurationTest {

		<b class="conum">(2)</b>
		private final WebSocketClient socketClient = new ReactorNettyWebSocketClient();

		<b class="conum">(3)</b>
		private final WebClient webClient = WebClient.builder().build();

		<b class="conum">(4)</b>
		private Profile generateRandomProfile() {
				return new Profile(UUID.randomUUID().toString(), UUID.randomUUID().toString() + "@email.com");
		}

		@Test
		public void testNotificationsOnUpdates() throws Exception {

				int count = 10; <b class="conum">(5)</b>
				AtomicLong counter = new AtomicLong(); <b class="conum">(6)</b>
				URI uri = URI.create("ws://localhost:8080/ws/profiles"); <b class="conum">(7)</b>

				<b class="conum">(8)</b>
				socketClient.execute(uri, (WebSocketSession session) -&gt; {

						<b class="conum">(9)</b>
						Mono&lt;WebSocketMessage&gt; out = Mono.just(session.textMessage("test"));

						<b class="conum">(10)</b>
						Flux&lt;String&gt; in = session
							.receive()
							.map(WebSocketMessage::getPayloadAsText);

						<b class="conum">(11)</b>
						return session
							.send(out)
							.thenMany(in)
							.doOnNext(str -&gt; counter.incrementAndGet())
							.then();

				}).subscribe();

				<b class="conum">(12)</b>
				Flux
					.&lt;Profile&gt;generate(sink -&gt; sink.next(generateRandomProfile()))
					.take(count)
					.flatMap(this::write)
					.blockLast();

				Thread.sleep(1000);

				Assertions.assertThat(counter.get()).isEqualTo(count); <b class="conum">(13)</b>
		}

		private Publisher&lt;Profile&gt; write(Profile p) {
				return
					this.webClient
						.post()
						.uri("http://localhost:8080/profiles")
						.body(BodyInserters.fromObject(p))
						.retrieve()
						.bodyToMono(String.class)
						.thenReturn(p);
		}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>There are no slices in this test. We&#8217;re starting up the whole application. Spring Boot lets us still exercise some control over things like the port to which the application binds when it starts.</p>
</li>
<li>
<p>Spring WebFlux provides a reactive <code>WebSocketClient</code> that we&#8217;ll use to consume messages coming off of the websocket stream</p>
</li>
<li>
<p>Spring WebFlux also provides a reactive HTTP client, perfect for talking to other microservices.</p>
</li>
<li>
<p>We&#8217;re going to generate some random data and have it written to our MongoDB repository</p>
</li>
<li>
<p>the plan is to write ten items using the  <code>POST</code> endpoint in our API. We&#8217;ll first subscribe to the websocket endpoint and then we&#8217;ll start consuming and confirm that we&#8217;ve got ten records.</p>
</li>
<li>
<p>the websocket notifications will come in asynchronously, so we will use a Java <code>AtomicLong</code> to capture the count in a threadsafe manner</p>
</li>
<li>
<p>Note that we&#8217;re talking to a <code>ws://</code> endpoint, not an <code>http://</code> endpoint</p>
</li>
<li>
<p>the <code>socketClient</code> lets us subscribe to the websocket endppint. It returns a <code>Publisher&lt;T&gt;</code> which this test promptly then subscribes to.</p>
</li>
<li>
<p>We send a throw away message to get the conversation started..</p>
</li>
<li>
<p>then we setup a reactive pipeline to subscribe to any incoming messages coming in from the websocket endpoint as a <code>WebSocketMessage</code> endpoint whose String contents we unpack.</p>
</li>
<li>
<p>we use the <code>WebSocketSession</code> to write and receive data. For each item that&#8217;s returned we increment our <code>AtomicLong</code></p>
</li>
<li>
<p>Now that the websocket subscriber is up and running,  we create a pipeline of elements that gets limited to <code>count</code> elements (<code>10</code>) and then issue <code>count</code> HTTP <code>POST</code> writes to the API using the reactive <code>WebClient</code>. We use <code>blockLast()</code> to force the writes to happen before we proceed to the next line where we compare consumed records.</p>
</li>
<li>
<p>finally, after all the writes have occured and another second of padding to spare has elapsed, we confirm that we&#8217;ve seen <code>count</code> notifications for our <code>count</code> writes.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>All green! Nothing better than a green test suite, I always say. It looks like things are on the up and up.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps">Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our brief time together we&#8217;ve looked at the need for asynchronous IO, the missing computational metaphor, the reactive streams specification, Pivotal&#8217;s Reactor project, Spring&#8217;s new reactive groove, Spring Data Kay and reactive MongoDB, Spring MVC-style HTTP endpoints, functional programming with Java 8 and functional reactive HTTP endpoints, reactive websockets, integration with non-reactive event sources and - through it all - testing! But this is just the beginning. We&#8217;re missing security and a slick HTML client, after all..</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-09-17 00:18:40 PDT
</div>
</div>
</body>
</html>